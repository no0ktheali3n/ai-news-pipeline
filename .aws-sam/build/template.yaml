AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Lambda deployment for AI Research Poster Pipeline
Parameters:
  S3OutputBucket:
    Type: String
    Description: S3 bucket used for storing output data
  ScraperOutputPrefix:
    Type: String
    Default: ai-research-pipeline/output/scraper/
    Description: Prefix for scraper output
  SummarizerOutputPrefix:
    Type: String
    Default: ai-research-pipeline/output/summarizer/
    Description: Prefix for summarizer output
  PosterOutputPrefix:
    Type: String
    Default: ai-research-pipeline/output/poster/
    Description: Prefix for poster output
  BedrockModelId:
    Type: String
    Default: anthropic.claude-3-5-sonnet-20240620-v1:0
    Description: Bedrock model to use for summarization
Globals:
  Function:
    Timeout: 600
    Runtime: python3.11
    MemorySize: 512
Resources:
  CommonUtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: common-utils
      Description: Shared utility code for all AI pipeline Lambdas
      ContentUri: ..\..\lambda\layers\common
      CompatibleRuntimes:
      - python3.11
      RetentionPolicy: Retain
  OrchestratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ai-research-summary-orchestrator
      Handler: orchestrator_lambda.handler
      CodeUri: OrchestratorFunction
      Layers:
      - Ref: CommonUtilsLayer
      Description: Orchestrates chunking and summarization of scraped data in parallel
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          - s3:PutObject
          - s3:GetObject
          - s3:ListBucket
          Resource:
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${ScraperOutputPrefix}*
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${SummarizerOutputPrefix}*
          - Fn::GetAtt:
            - SummarizerFunction
            - Arn
      Environment:
        Variables:
          S3_OUTPUT_BUCKET:
            Ref: S3OutputBucket
          SCRAPER_OUTPUT_PREFIX:
            Ref: ScraperOutputPrefix
          SUMMARIZER_OUTPUT_PREFIX:
            Ref: SummarizerOutputPrefix
          SUMMARIZER_FUNCTION_NAME:
            Ref: SummarizerFunction
    Metadata:
      SamResourceId: OrchestratorFunction
  ScraperFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ai-research-scraper
      Handler: scraper_lambda.handler
      CodeUri: ScraperFunction
      Layers:
      - Ref: CommonUtilsLayer
      Description: Scrapes articles
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          Resource:
            Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${ScraperOutputPrefix}*
      Environment:
        Variables:
          S3_OUTPUT_BUCKET:
            Ref: S3OutputBucket
          SCRAPER_OUTPUT_PREFIX:
            Ref: ScraperOutputPrefix
    Metadata:
      SamResourceId: ScraperFunction
  SummarizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ai-research-summarizer
      Handler: summarizer_lambda.handler
      CodeUri: SummarizerFunction
      Layers:
      - Ref: CommonUtilsLayer
      Description: Summarizes articles using Bedrock & FMs
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:ListFoundationModels
          - s3:GetObject
          - s3:PutObject
          - s3:ListBucket
          Resource:
          - Fn::Sub: arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-5-sonnet-20240620-v1:0
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${ScraperOutputPrefix}*
          - Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${SummarizerOutputPrefix}*
      Environment:
        Variables:
          S3_OUTPUT_BUCKET:
            Ref: S3OutputBucket
          SCRAPER_OUTPUT_PREFIX:
            Ref: ScraperOutputPrefix
          SUMMARIZER_OUTPUT_PREFIX:
            Ref: SummarizerOutputPrefix
          BEDROCK_MODEL_ID:
            Ref: BedrockModelId
    Metadata:
      SamResourceId: SummarizerFunction
  PosterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ai-research-poster
      Handler: poster_lambda.handler
      CodeUri: PosterFunction
      Description: Posts summaries to Twitter
      Layers:
      - Ref: CommonUtilsLayer
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          - s3:GetObject
          Resource:
            Fn::Sub: arn:aws:s3:::${S3OutputBucket}/${PosterOutputPrefix}*
      Environment:
        Variables:
          S3_OUTPUT_BUCKET:
            Ref: S3OutputBucket
          POSTER_OUTPUT_PREFIX:
            Ref: PosterOutputPrefix
    Metadata:
      SamResourceId: PosterFunction
Outputs:
  OrchestratorOutput:
    Description: Orchestrator Lambda Function ARN
    Value:
      Fn::GetAtt:
      - OrchestratorFunction
      - Arn
  PosterOutput:
    Description: Poster Lambda Function ARN
    Value:
      Fn::GetAtt:
      - PosterFunction
      - Arn
  SummarizerOutput:
    Description: Summarizer Lambda Function ARN
    Value:
      Fn::GetAtt:
      - SummarizerFunction
      - Arn
  ScraperOutput:
    Description: Scraper Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ScraperFunction
      - Arn
